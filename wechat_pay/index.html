<!doctype html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport'
        content='width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0'>
  <meta http-equiv='X-UA-Compatible' content='ie=edge'>
  <title>交易进行中...</title>
  <link rel='stylesheet' href='./wechat_pay.css'>
  <script src='./jquery-1.10.2.min.js' type='text/javascript'></script>
</head>
<body>
<p class='tradeState'>交易进行中...</p>

<div class='orderDetails'>
  <p>订&nbsp;单&nbsp;号：<span id='orderNo'></span></p>
  <p>商品名称：<span id='softName'></span></p>
  <p>交易金额：￥
    <span id='softPrice'></span>
  </p>
  <p>交易时间：
    <sppn id='orderTime'></sppn>
  </p>
</div>
<div style='text-align:center; padding:30px 5px 0px 5px;'>
  <button class='btnPay' type='button'>重新支付</button>
</div>
<script>
  /**
   * @description 获取地址栏任意参数
   * @param name 参数名
   * @returns {string}
   */
  function getQueryString(name) {
    var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)')
    var r = window.decodeURIComponent(window.location.search).substr(1).match(reg)
    if (r != null)
      return decodeURI(r[2])
    return ''
  }

  /**
   * @description 设置页面信息
   * @param orderNo 订单号
   * @param packageName 套餐名称
   * @param price 价格
   * @param orderTime 下单时间
   */
  function setPageInfo({ orderNo, packageName, price, orderTime }) {
    document.getElementById('orderNo').innerHTML = orderNo
    document.getElementById('softName').innerHTML = packageName
    document.getElementById('softPrice').innerHTML = price
    document.getElementById('orderTime').innerHTML = orderTime
  }


  /**
   * @description 支付结果回调
   * @param payResult 支付结果
   */
  function wechatPayCallBack(payResult) {
    if (payResult.err_msg == 'get_brand_wcpay_request:ok') {
      WeixinJSBridge.call( 'closeWindow' ); //微信
    } else if (payResult.err_msg == 'get_brand_wcpay_request:cancel') {
      alert('用户取消支付!')
    } else {
      alert(JSON.stringify(payResult))
    }
  }

  /**
   * @description 微信支付API
   * @param paramData 微信支付参数，参数详情：https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_4.shtml
   */
  function onBridgeReady(paramData) {
    WeixinJSBridge.invoke('getBrandWCPayRequest', paramData, wechatPayCallBack)
  }

  /**
   * @description 调起微信支付
   * @param paramData 微信支付参数，参数详情：https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_4.shtml
   */
  function callWechatPay(paramData) {
    if (typeof WeixinJSBridge == 'undefined') {
      if (document.addEventListener) {
        document.addEventListener('WeixinJSBridgeReady', function() {
          onBridgeReady(paramData)
        }, false)
      } else if (document.attachEvent) {
        document.attachEvent('WeixinJSBridgeReady', function() {
          onBridgeReady(paramData)
        })
        document.attachEvent('onWeixinJSBridgeReady', function() {
          onBridgeReady(paramData)
        })
      }
    } else {
      onBridgeReady(paramData)
    }
  }

  function getTime() {
    let date = new Date();
    return `${date.getFullYear()}-${date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1}-${date.getDate() < 10 ? '0' + date.getDate() : date.getDate()} ${date.getHours < 10 ? '0' + date.getHours() : date.getHours()}:${date.getMinutes < 10 ? '0' + date.getMinutes() : date.getMinutes()}:${date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds()}`
  }

  /**
   * @description 创建订单
   * @param wxCode
   */
  function createWxOrder(wxCode) {
    $.ajax({
      method: 'POST',
      url: 'https://passportapi.qingmiao.com/api/createwxorder',
      header: {
        'Content-Type': 'application/json'
      },
      dataType: 'json',
      data: JSON.stringify({
        'wx_code': wxCode,
        'order_id': getQueryString('order_id')
      }),
      success: function(res) {
        // TODO 判断返回值是成功态 还是 失败，需同后端确定
        setPageInfo({
          orderNo: getQueryString('order_id'),
          packageName: JSON.parse(getQueryString('state'))['shopname'],
          price: JSON.parse(getQueryString('state'))['price'],
          orderTime: getTime()
        })
        callWechatPay(res.data)
      },
      fail: function(err) {
        // TODO 创建失败
      }
    })
  }

  /**
   * @description 重新发起支付
   */
  function reloadCallWechatPay() {
    window.location.href = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx249797752ba99ce2&redirect_uri=https://passportapi.qingmiao.com/wechat_pay?order_id=${getQueryString('order_id')}&response_type=code&scope=snsapi_base&state=${JSON.stringify({"shopname": JSON.parse(getQueryString('state'))['shopname'], "price": JSON.parse(getQueryString('state'))['price']})}&connect_redirect=1#wechat_redirect`
  }

  let wxCode = getQueryString('code')

  // 如果url中没有code,则跳转微信授权
  if (!wxCode) {
    window.location.href = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx249797752ba99ce2&redirect_uri=https://passportapi.qingmiao.com/wechat_pay?order_id=${getQueryString('order_id')}&response_type=code&scope=snsapi_base&state=${JSON.stringify({"shopname": getQueryString('shopname'), "price": getQueryString('price') / 100})}&connect_redirect=1#wechat_redirect`
  } else {
    createWxOrder(wxCode)
  }
  /**
   * 重新支付
   */
  $('.btnPay').on('click', function () {
    reloadCallWechatPay()
  })

</script>

</body>
</html>